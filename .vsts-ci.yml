name: $(Build.BuildId)
pool:
  vmImage: 'ubuntu-16.04'
trigger:
- master
steps:

- bash: |
   sudo pip install setuptools
   sudo pip install awscli
   export AWS_SECRET_ACCESS_KEY=$(AWS_SECRET_ACCESS_KEY)
   chmod +x ./pipeline.sh
   ./pipeline.sh $(Build.BuildId) $(System.DefaultWorkingDirectory)
  displayName: Pipeline Bash Script

- task: PublishBuildArtifacts@1
  displayName: "Publish Artifact: manifests"
  inputs:
    PathtoPublish: deployment/k8s
    ArtifactName: manifests

- bash: |
   chmod +x ./deployment/k8s/set-image.sh
   chmod +x ./deployment/k8s/update-git.sh
   
   ./set-image.sh --overlay production --image "579478677147.dkr.ecr.eu-central-1.amazonaws.com/malware-scan/malware-scanner-service:$(Build.BuildId)"
   ./update-git.sh --message "chore(deployment) update malware-scanner-service to '$(Build.BuildId)' ***NO_CI***"
  displayName: Set production image tag