var express = require('express');
var app = express();
var multer = require('multer')
var upload = multer()
var sparkMd5 = require('spark-md5');
var hostAddress = "";

app.get('/api/v1/scans/:id', function (req, res) {

    let infected = req.query.infected === "true" ? true : false;
    let scanResult = {
        "id": req.params.id,
        "status": "done",
        "report": {
            "infected": infected
        }
    };

    res.send(scanResult);
});

app.post('/api/v1/scans', upload.single('file'), function (req, res, next) {

    var file = req.file;
    hash = sparkMd5.hash(file.buffer + '');

    res.setHeader('Location', hostAddress + "/api/v1/scans/" + hash);
    res.end();

    
});

var server = app.listen(8081, function () {
    var host = server.address().address;
    var port = server.address().port;
    hostAddress = `http://${host}:${port}`;
    console.log("Virus scanner listening at %s", hostAddress);
});