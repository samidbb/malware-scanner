#!/bin/bash
echo $PWD
# build parameters
readonly REGION=${AWS_DEFAULT_REGION:-"eu-central-1"}
readonly CAPABILITY_NAME='malware-scan'
readonly IMAGE_NAME="${CAPABILITY_NAME}/malware-scanner-service"
readonly BUILD_NUMBER=${1:-"N/A"}

build_container_image() {
    echo "Building container image .."
    
    docker build --tag ${IMAGE_NAME} ./src/api-server/
}

push_container_image() {
    echo "### Loging into to docker ###"
    $(aws ecr get-login --no-include-email)

    echo "### Tagging container image ###"
    account_id=$(aws sts get-caller-identity --output text --query 'Account')
    ecr_path="${account_id}.dkr.ecr.${REGION}.amazonaws.com/"
    container_registry_image_name="${ecr_path}${IMAGE_NAME}:${BUILD_NUMBER}"

    echo "Tag will be: '${container_registry_image_name}'"
    docker tag ${IMAGE_NAME}:latest ${container_registry_image_name}

    echo "### Pushing container image to container registry ###"
    docker push ${container_registry_image_name}
}

tag_production_deployment(){
    origin_path=$PWD
    cd deployment/k8s/
    :
    ./set-image.sh --overlay production --image "579478677147.dkr.ecr.eu-central-1.amazonaws.com/malware-scan/malware-scanner-service:${BUILD_NUMBER}"

    cd $origin_path
    :
}


build_container_image

if [[ "${BUILD_NUMBER}" != "N/A" ]]; then
    push_container_image
    tag_production_deployment
fi

