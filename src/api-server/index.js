var express = require('express');
var app = express();
var multer = require('multer')
var upload = multer({ dest: './data/queue/' })
const fs = require('fs')

var hostAddress = "";

app.post('/api/v1/scans', upload.single('file'), function (req, res, next) {


    var file = req.file;



    if (typeof file === 'undefined') {
        const error = new Error('No file uploaded');
        error.httpStatusCode = 400
        return next(error)
    }
    var timeOutDate = new Date();
    timeOutDate.setMinutes(timeOutDate.getMinutes() + 1);
    while (fs.existsSync(file.path)) {
        // Wait till the file gets picked up
        if(timeOutDate <  Date.now()) {
            res.send('The file did not get picked up by the virus scanner');
            return;
        }
    }
    var fileEmerged = false;

    while (fileEmerged === false) {
        if (fs.existsSync('./data/nok/' + file.filename)) {
            res.send('It is infected');
            fileEmerged = true;
        }
        if (fs.existsSync('./data/ok/' + file.filename)) {
            res.send('All is well');
            fileEmerged = true;
        }
    }

});

var server = app.listen(8081, function () {
    var host = server.address().address;
    var port = server.address().port;
    hostAddress = `http://${host}:${port}`;
    console.log("Virus scanner listening at %s", hostAddress);
});