var express = require('express');
var app = express();
var multer = require('multer')
var upload = multer({ dest: 'data/queue/' })
var sparkMd5 = require('spark-md5');
var hostAddress = "";

app.post('/api/v1/scans', upload.single('file'), function (req, res, next) {

  
    var file = req.file;

    if(typeof file === 'undefined'){
        res.status(400).send('No file uploaded');
        return;
    }

    hash = sparkMd5.hash(file.buffer + '');

    let infected = req.query.infected === "true" ? true : false;
    let scanResult = {
        "id": hash,
        "status": "done",
        "report": {
            "infected": infected
        }
    };

    res.send(scanResult);
    
});

var server = app.listen(8081, function () {
    var host = server.address().address;
    var port = server.address().port;
    hostAddress = `http://${host}:${port}`;
    console.log("Virus scanner listening at %s", hostAddress);
});