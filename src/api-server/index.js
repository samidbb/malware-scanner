var express = require('express');
var app = express();
var multer = require('multer');
var upload = multer({ dest: './data/queue/' });
var fs = require('fs');

var hostAddress = "";

app.post('/api/v1/scans', upload.single('file'), function (req, res, next) {

    var file = req.file;

    if (typeof file === 'undefined') {
        var error = new Error('No file uploaded');
        error.httpStatusCode = 400;
        return next(error);
    }


    var timeOutDate = new Date();
    timeOutDate.setMinutes(timeOutDate.getMinutes() + 1);
    while (fs.existsSync(file.path)) {
        // Wait till the file gets picked up
        if (timeOutDate < Date.now()) {
            res.send('The file did not get picked up by the virus scanner');
            return;
        }
    }


    var infectedFilePath = './data/nok/' + file.filename;
    var healthyFilePath = './data/ok/' + file.filename;

    while (true) {
        if (fs.existsSync(infectedFilePath)) {
            fs.unlinkSync(infectedFilePath);

            var scanResult = {
                "id": file.filename,
                "status": "done",
                "report": {
                    "infected": true
                }
            };
            res.send(scanResult);
            return;
        }
        if (fs.existsSync(healthyFilePath)) {
            fs.unlinkSync(healthyFilePath);

            var scanResult = {
                "id": file.filename,
                "status": "done",
                "report": {
                    "infected": false
                }
            };
            res.send(scanResult);
            return;
        }
    }
});

var server = app.listen(8081, function () {
    var host = server.address().address;
    var port = server.address().port;
    hostAddress = `http://${host}:${port}`;
    console.log("Virus scanner listening at %s", hostAddress);
});